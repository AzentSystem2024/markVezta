<div class="view-wrapper list-page">
  <div *ngIf="isLoading" class="loading-overlaaay">
    <div class="spinner"></div>
  </div>
  <dx-data-grid
    class="grid theme-dependent"
    [dataSource]="Advance_Options"
    [remoteOperations]="false"
    [showBorders]="true"
    [width]="'100%'"
    [height]="'80vh'"
    [allowColumnReordering]="true"
    [rowAlternationEnabled]="true"
    noDataText=" "
    [showColumnLines]="true"
    (onEditingStart)="onEditStart($event)"
    (onRowRemoved)="deleteData($event)"
    [scrolling]="{ mode: 'standard' }"
    [filterRow]="{ visible: false }"
      [headerFilter]="{ visible: false }"
     
  >
  
   <dxo-filter-row
  [visible]="isFilterRowVisible"
></dxo-filter-row>

      <dxo-header-filter [visible]="isFilterOpened">
        <dxo-search [enabled]="true"></dxo-search>
      </dxo-header-filter>
      <!-- <dxo-filter-panel [visible]="isFilterOpened"></dxo-filter-panel> -->
      <dxo-filter-builder [allowHierarchicalFields]="true">
      </dxo-filter-builder>
    <dxo-editing mode="popup" [allowUpdating]="true"  [allowDeleting]="canDelete">
    </dxo-editing>
    <!-- <dxo-filter-row [visible]="true" [height]="10"></dxo-filter-row> -->
    <dxo-scrolling mode="standard"></dxo-scrolling>
    <!-- <dxo-header-filter [visible]="true"></dxo-header-filter> -->

       
    <dxo-paging [pageSize]="10"></dxo-paging>

    <dxo-pager
      [visible]="true"
      [allowedPageSizes]="allowedPageSizes"
      [displayMode]="displayMode"
      [showPageSizeSelector]="showPageSizeSelector"
      [showInfo]="true"
      [showNavigationButtons]="true"
    ></dxo-pager>

    <dxo-column-chooser
      [height]="500"
      hideOnOutsideClick="true"
      [enabled]="true"
      mode="select"
    >
    </dxo-column-chooser>

    <dxo-toolbar>
      <dxi-item location="before">
        <div class="grid-header">Salary Advance</div>
      </dxi-item>
      <!-- <dx-lookup [items]="Advance_Options" displayExpr="employeeName" valueExpr="employeeId"></dx-lookup> -->

      <dxi-item>
        <!-- <dx-select-box
  [(value)]="selectedRange"
  [dataSource]="dateRanges"
  displayExpr="label"
  valueExpr="value"
  (onValueChanged)="onDateRangeChange($event)"
  placeholder="Date Range"
  class="mb-3"
>
</dx-select-box> -->
      </dxi-item>
  
 <dxi-item
        location="after"
        locateInMenu="auto"
        showText="inMenu"
        widget="dxButton"
        [options]="{
          icon: isFilterRowVisible ? 'filter' : 'filter',
          hint: isFilterRowVisible ? 'Hide Filter Row' : 'Show Filter Row',
          onClick: toggleFilterRow,
          stylingMode: 'text',
          elementAttr: { class: 'commonButtons' }
        }"
      ></dxi-item>

       <dxi-item
          location="after"
          locateInMenu="auto"
          widget="dxButton"
          [options]="refreshButtonOptions"
        ></dxi-item>

      <dxi-item
      *ngIf="canAdd"
      location="after"
      widget="dxButton"
      [options]="addButtonOptions"
     
    ></dxi-item>
  <!-- *ngIf="canAdd" -->
 
    </dxo-toolbar>
    <dxi-column
    dataField="serialNo"
    caption="Sl.No"
    alignment="left"
    [allowEditing]="true"
    [allowFiltering]="false"
  ></dxi-column>
    <dxi-column
      dataField="ADV_NO"
      caption="Doc.No"
      alignment="left"
      [allowEditing]="true"
      [allowFiltering]="false"
    
    ></dxi-column>
    <dxi-column dataField="DATE" caption="Date"></dxi-column>
    <dxi-column
      dataField="EMP_NO"
      caption="Employee No"
      alignment="left"
    ></dxi-column>
    <dxi-column
      dataField="EMP_NAME"
      caption="Employee Name"
      
    ></dxi-column>
    <dxi-column
      dataField="ADV_TYPES"
      caption="Advance Type"
      
    ></dxi-column>
 
    <dxi-column
    dataField="AMOUNT"
    caption="Amount"
   
    alignment="right"
    [format]="{ type: 'fixedPoint', precision: 2 }"
  ></dxi-column>
  <dxi-column dataField="STATUS" caption="Status" alignment="center" cellTemplate="statusCellTemplate"
  fixedPosition="right">
  </dxi-column>
  <div *dxTemplate="let cellData of 'statusCellTemplate'">
    <i
      class="fas fa-flag"
      [ngClass]="getStatusFlagClass(cellData.value)"
      [attr.title]="cellData.value"
      style="margin-left: 10px; cursor: default;"
    ></i>
      </div>

<dxi-column
  type="buttons"
  [buttons]="gridButtons">
</dxi-column>
    <!-- <dxi-column type="buttons" [buttons]="allActionButtons" fixed="true" fixedPosition="right"width="150"></dxi-column> -->
  </dx-data-grid>
</div>



<!-- ============================================Add form============================== -->

<form-popup 
  (onHiding)="closeButton()"
  [(visible)]="isAddPopUp"
  titleText="Advance "
  [width]=600
  [height]=530
  [dragEnabled]="true"
  (save)="Add_Advace()"
  (cancel)="close()"
>
 <dx-validation-group class="form-grid" #formValidationGroup>
  <dx-form id="form" [formGroup]="formSource">
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <!-- Document No -->
      <dxi-item>
        <dx-text-box label="Document No" [labelMode]="'floating'" [readOnly]="true"></dx-text-box>
      </dxi-item>

      <!-- Date Picker -->
      <dxi-item>
        <dx-date-box
          label="Date"
          placeholder="dd/mm/yyyy"
          [showClearButton]="true"
          [useMaskBehavior]="true"
          [displayFormat]="'dd/MM/yyyy'"
          type="date"
          [inputAttr]="{ 'aria-label': 'Date' }"
          formControlName="Date"
          [labelMode]="'floating'"

        ></dx-date-box>
        
      </dxi-item>
    </dxi-item>
      <dxi-item class="select-box">
        <dx-select-box
        [(value)]="employee_ID" 
        [items]="EMPLOYEE_VALUE"
        displayExpr="DESCRIPTION"
      
        valueExpr="ID"
          label="Employee"
          [labelMode]="'floating'"
          [searchEnabled]="true"
          placeholder="Select.."
          formControlName="employee_ID"
          (onValueChanged)="onEmployee_Change($event)"
        >
        <dx-validator>
          <dxi-validation-rule
            type="required"
            message="This field is required"
          ></dxi-validation-rule> </dx-validator
      >
      </dx-select-box>
      </dxi-item>
      
   
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item>
        <dx-number-box
          label="Amount"
          [labelMode]="'floating'"
             [format]="'currency'"
                 [readOnly]="isEditReadOnly"
          formControlName="Amount"
          valueChangeEvent="input"
            [format]="'#,##0.##'"
          (onValueChanged)="onAmountInput($event)"
          [inputAttr]="{ style: 'text-align: right;' }"
          
        >
        <dx-validator>
          <dxi-validation-rule
            type="required"
            message="This field is required"
          ></dxi-validation-rule> </dx-validator
      >
      </dx-number-box>
      </dxi-item>
      <dxi-item class="select-box">
        <dx-select-box
        [(value)]="Advance_types_ID" 
        [items]="ADVANCETYPE_VALUE"
        displayExpr="DESCRIPTION"
        valueExpr="ID"
        [labelMode]="'floating'"
          label="Advance Type"
          formControlName="Advance_types_ID"
          [searchEnabled]="true"
          placeholder="Select.."
          (onValueChanged)="onAdvance_type_Change($event)"
        >
        <dx-validator>
          <dxi-validation-rule
            type="required"
            message="This field is required"
          ></dxi-validation-rule> </dx-validator
      ></dx-select-box>
      </dxi-item>
    </dxi-item>

    <dxi-item style="text-align: center">
      <label style="display: block; text-align: left; text-decoration: underline; text-underline-offset: 4px;">
        Recovery details:
      </label>
      
    </dxi-item>

    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item>
        <dx-number-box
         [inputAttr]="{ style: 'text-align: right;' }"
       
          label="Net amount to be recovered"
          [labelMode]="'floating'"
          formControlName="Net_Amount_recoverd"
           [format]="'currency'"
             [format]="'#,##0.##'"
          valueChangeEvent="input"
        ></dx-number-box>
      </dxi-item>
         <dxi-item>
        <dx-text-box
          label="Amt. Recovered through Salary"
          [inputAttr]="{ style: 'text-align: right;' }"
          valueChangeEvent="input"
          [readOnly]="true"
          [labelMode]="'floating'"
        ></dx-text-box>
      </dxi-item>

    </dxi-item>

    <dxi-item itemType="group" [colCount]="3" [colSpan]="3">
      <dxi-item
      ><dx-number-box
        label="No of  installments"
        [inputAttr]="{ style: 'text-align: right;' }"
        valueChangeEvent="input"
        [labelMode]="'floating'"
        formControlName="No_installments"
      ></dx-number-box
    ></dxi-item>

      <dxi-item
        ><dx-number-box
          label="Installment Amount"
          valueChangeEvent="input"
          [labelMode]="'floating'"
           [format]="'currency'"
             [format]="'#,##0.##'"
          formControlName="installmen_amt"
          [inputAttr]="{ style: 'text-align: right;' }"

        ></dx-number-box
      ></dxi-item>
          <dxi-item>
        <dx-date-box
        [labelMode]="'floating'"
        label="Recovery Starts from"
        [showClearButton]="true"
        displayFormat="MMMM/yyyy"
        [min]="minDate"
        pickerType="calendar"
        formControlName="Recovery_Date"
        [inputAttr]="{ 'aria-label': 'Recovery_Date' }"
        [calendarOptions]="{
          maxZoomLevel: 'year',
          minZoomLevel: 'century'
        }"
        (onValueChanged)="onRecoveryDateChanged($event)"
        >
      </dx-date-box>
      </dxi-item>
    </dxi-item>
    <dxi-item
      ><dx-text-box
        label="Remarks"
        valueChangeEvent="input"
        formControlName="Remarks"
      ></dx-text-box
    ></dxi-item>
<!--     
    <dxi-item style="text-align: center">
      <label>Payment Details</label>
    </dxi-item>
    
    
<dxi-item>
<label for="paymentModeRadio">Payment Mode</label>
<dx-radio-group
 id="paymentModeRadio"
  [items]="paymentModes"
  [(value)]="selectedPaymentMode"
  displayExpr="label"
  valueExpr="value"
  layout="horizontal"
  label="Payment Mode"
  [width]="300"
>
</dx-radio-group>


</dxi-item>
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item>
        <dx-text-box
          label="Voucher No"
          [labelMode]="'floating'"
          [(value)]="payment_Detilas.VOUCHER_NO"
   
        ></dx-text-box>
      </dxi-item>

      <dxi-item>
        <dx-date-box
        label="Voucher Date"
        [(value)]="payment_Detilas.TRANS_DATE"
  
        labelMode="floating"
        displayFormat="dd/MM/yyyy"
      ></dx-date-box>
    </dxi-item>
      </dxi-item>
   
<dxi-item>
        <dx-select-box
          label=" Payment Ac"
          [labelMode]="'floating'"
          [inputAttr]="{ style: 'text-align: right;' }"
          [(value)]="payment_Detilas.AMOUNT_PAID"

          placeholder="0"
        ></dx-select-box>
      </dxi-item>
      <label style="text-decoration: underline; text-underline-offset: 4px;">
      Bank remittance Details
      </label>
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      
  
      <dxi-item>
        <dx-text-box
          label="Cheque No"
          [labelMode]="'floating'"
          [(value)]="payment_Detilas.PAYMENT_REFERENCE"
       
        ></dx-text-box>
      </dxi-item>
         <dxi-item>
        <dx-date-box
        label="Due Date"
        [(value)]="payment_Detilas.TRANS_DATE"
        labelMode="floating"
        displayFormat="dd/MM/yyyy"
      ></dx-date-box>
    </dxi-item>
    </dxi-item> -->
  </dx-form>
  </dx-validation-group>
</form-popup>

<!-- ========================Edit Advance ==============================
  -->
  <dx-popup
  (onHiding)="closeButton()"
  [(visible)]="isEditPopUp"
  title="Advance "
  [width]="640"
  [height]="700"
>
  <dx-form id="form">
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <!-- Document No -->
      <dxi-item>
        <dx-text-box
          label="Document No"
          [readOnly]="true"
          [(value)]="adv_no_value"
          [labelMode]="'floating'"
        ></dx-text-box>
      </dxi-item>

      <!-- Date Picker -->
      <dxi-item>
        <dx-date-box
          label="Date"
          [(value)]="date_value"
          displayFormat="dd/MM/yyyy"
          [pickerType]="'calendar'"
            [readOnly]="isEditReadOnly"
          (onValueChanged)="onDateValueChanged($event)"
          [labelMode]="'floating'"
        ></dx-date-box>
      </dxi-item>
    </dxi-item>

    <dxi-item class="select-box">
      <dx-select-box
        [(value)]="emp_id"
        [items]="EMPLOYEE_VALUE"
        displayExpr="DESCRIPTION"
        valueExpr="ID"
        [searchEnabled]="true"
          [readOnly]="isEditReadOnly"
        placeholder="Select.."
        dataField="employee_name"
        label="Employee"
        (onValueChanged)="onEmployee_Change($event)"
        [labelMode]="'floating'"
      ></dx-select-box>
    </dxi-item>

    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item class="select-box">
        <dx-select-box
          [(value)]="adv_type_id_value"
          [items]="ADVANCETYPE_VALUE"
          displayExpr="DESCRIPTION"
            [readOnly]="isEditReadOnly"
          valueExpr="ID"
          [searchEnabled]="true"
          [displayCustomValue]="true"
          placeholder="Select.."
          label="Advance Types"
          (onValueChanged)="onAdvance_type_Change($event)"
          [labelMode]="'floating'"
        >
          <ng-template let-data dxTemplate="value">
            {{ getAdvanceTypeName(data) }}
          </ng-template>
        </dx-select-box>
      </dxi-item>

      <dxi-item>
        <dx-number-box
          label="Amount"
           [format]="'currency'"
             [format]="'#,##0.##'"
          valueChangeEvent="input"
            [readOnly]="isEditReadOnly"
          [(value)]="Advance_Amount_value"
          (onValueChanged)="onAmountInput($event)"
          [inputAttr]="{ style: 'text-align: right;' }"
          [labelMode]="'floating'"
        ></dx-number-box>
      </dxi-item>
    </dxi-item>

    <dxi-item style="text-align: left">
      <label style="text-decoration: underline; text-underline-offset: 4px;">
        Recovery details:
      </label>
    </dxi-item>
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item>
        <dx-number-box
          label="Net amount to be recovered"
          [format]="'currency'"
            [format]="'#,##0.##'"
              [readOnly]="isEditReadOnly"
          valueChangeEvent="input"
          [(value)]="reco_Amount_value"
          [inputAttr]="{ style: 'text-align: right;' }"
          (valueChange)="onNetAmountUpdateChange()"
          [labelMode]="'floating'"
        ></dx-number-box>
      </dxi-item>

      <dxi-item>
        <dx-text-box
          label="Amt. Recovered through Salary"
          [inputAttr]="{ style: 'text-align: right;' }"
          valueChangeEvent="input"
          [(value)]="recoverd_Amt_value"
          [readOnly]="true"
          [labelMode]="'floating'"
        ></dx-text-box>
      </dxi-item>
    </dxi-item>

    <dxi-item itemType="group" [colCount]="3" [colSpan]="3">
      <dxi-item>
        <dx-number-box
          label="No of installments"
          valueChangeEvent="input"
             [format]="'currency'"
               [format]="'#,##0.##'"
                 [readOnly]="isEditReadOnly"
          [(value)]="reco_inst_count_value"
          (valueChange)="onInstallmentCountChange()"
          [inputAttr]="{ style: 'text-align: right;' }"
          [labelMode]="'floating'"
        ></dx-number-box>
      </dxi-item>

      <dxi-item>
        <dx-number-box
          label="Installment Amount"
            [format]="'#,##0.##'"
          valueChangeEvent="input"
            [readOnly]="isEditReadOnly"
          [(value)]="reco_install_Amount_value"
          [readOnly]="true"
          [labelMode]="'floating'"
        ></dx-number-box>
      </dxi-item>

      <dxi-item>
        <dx-date-box
          label="Recovery Starts from"
          [showClearButton]="true"
          displayFormat="MMMM/yyyy"
          pickerType="calendar"
                 [readOnly]="isEditReadOnly"
          [min]="minDateUpdate"
          (onValueChanged)="onRecoveryDateChanged($event)"
          [(value)]="reco_stat_month"
          [inputAttr]="{ 'aria-label': 'Recovery_Date' }"
          [calendarOptions]="{
            maxZoomLevel: 'year',
            minZoomLevel: 'century'
          }"
          labelMode="floating"
          style="border: 1px;"
        ></dx-date-box>
      </dxi-item>
    </dxi-item>


    <dxi-item>
      <dx-text-box
        label="Remarks"
        [(value)]="remark_value"
        [labelMode]="'floating'"
               [readOnly]="isEditReadOnly"
      ></dx-text-box>
    </dxi-item>
    <dxi-item style="text-align: center">
      <label>Payment Details</label>
    </dxi-item>
<dxi-item>

<dx-radio-group
  [items]="paymentModes"
  [(value)]="selectedPaymentMode"
  displayExpr="label"
  valueExpr="value"
  layout="horizontal"
         [readOnly]="isEditReadOnly"
  [width]="300"
     (onValueChanged)="paymentModesValue($event)"
>
</dx-radio-group>


</dxi-item>
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      <dxi-item>
        <dx-text-box
               [readOnly]="isEditReadOnly"
          label="Voucher No"
          [labelMode]="'floating'"
         [(value)]="adv_no_value"
   
        ></dx-text-box>
      </dxi-item>

      <dxi-item>
        <dx-date-box
        label="Voucher Date"
               [readOnly]="isEditReadOnly"
        [(value)]="date_value"
        labelMode="floating"
        displayFormat="dd/MM/yyyy"
      ></dx-date-box>
    </dxi-item>
      </dxi-item>
   
<dxi-item>
        <dx-select-box
          label=" Payment Ac"
          [labelMode]="'floating'"
                [readOnly]="isEditReadOnly"
          [(value)]="Payment_Head"
     [searchEnabled]="true"
  [items]="payment_Detilas"
  displayExpr="HEAD_NAME"
  valueExpr="HEAD_ID"
          placeholder=" Payment Ac"
        ></dx-select-box>
      </dxi-item>
      <label style="text-decoration: underline; text-underline-offset: 4px;">
      Bank remittance Details
      </label>
    <dxi-item itemType="group" [colCount]="2" [colSpan]="2">
      
  
      <dxi-item>
     <dx-text-box
  label="Cheque No"
  [labelMode]="'floating'"
  [(value)]="selected_Cheque_No"
         [readOnly]="isEditReadOnly"
  [visible]="selectedPaymentMode == '14'"
></dx-text-box>

      </dxi-item>
         <dxi-item>
        <dx-date-box
        label="Due Date"
               [readOnly]="isEditReadOnly"
        [(value)]="selected_Cheque_Date"
        labelMode="floating"
        displayFormat="dd/MM/yyyy"
        [visible]="selectedPaymentMode == '14'"
      ></dx-date-box>
    </dxi-item>
    </dxi-item>
    <dxi-item>   
      <dx-check-box
           [(value)]="approveValue"
              text="Approve"
                     [readOnly]="isEditReadOnly"
              (onValueChanged)="onApprovedChanged($event)"
              style="margin:10px"
            >
            </dx-check-box></dxi-item>
    <dxi-item class="fixed-footer" itemType="group" [colCount]="2" [colSpan]="2">
      <div class="fixed-footer">
        <dx-button
          text="Cancel"
          (onClick)="close()"
          
        ></dx-button>
        <dx-button
        [visible]="!isEditReadOnly"
          class="saveBtn"
          [text]="approveValue ? 'Update & Commit' : 'Update'"
          stylingMode="contained"
          (onClick)="Update_advance()"
        ></dx-button>
      </div>
    </dxi-item>
  </dx-form>
</dx-popup>